<!docytpe html>

<html>

<head>

	<meta name="author" content="Maurycy Skier" />

	<title>Disk sectors visualizer</title>

	<link rel="stylesheet" href="style.css" />

	<script src="parser.js"></script>
	<script src="disk.js"></script>

	<script>

		var Canvas = function( id ) {

			this.canvas = document.getElementById( id );
			if( !canvas )
				throw new Error( "LOL" );
			this.context = canvas.getContext( "2d" );
			if( !this.context )
				throw new Error( "OMG" );

			this.width = 0;
			this.height = 0;

			this.resize = function() {
				this.width = window.innerWidth;
				this.height = window.innerHeight;
				this.canvas.setAttribute( "width", this.width );
				this.canvas.setAttribute( "height", this.height );
				this.afterResize( this.width, this.height );
			}

			this.afterResize = function() {}

		};

		document.addEventListener( "DOMContentLoaded", function() {

			// Initialize elements
			var info = document.getElementById( "info" );
			var canvas = new Canvas( "canvas" );
			canvas.resize();
			window.onresize = function() {
				canvas.resize();
			}

			// Base variables
			var parser, disk, LBA, blockSize;

			// Create parser
			parser = new Parser();

			// Set base variables
			parser.on( "header", function( header ) {
				document.title = header["Model"];
				LBA = header["LBA"];
				blockSize = header["Block size"];
			} );

			// When data has been parsed create disk and draw screen of blocks
			parser.on( "data", function( data ) {
				disk = new Disk( LBA, blockSize, data );
				disk.board( canvas.context, info, canvas.width, canvas.height );
				disk.blockStyle( 10, 20, 1 );
				disk.visualize();
				canvas.afterResize = function( width, height ) {
					disk.boardResize( width, height );
					disk.visualize();
				}
				// Bind some functions to keys
				document.addEventListener( "keydown", function( event ) {
					var goodKey = true;
					switch( event.keyCode ) {
						// home, end
						case 36:
							disk.offset.start();
							break;
						case 35:
							disk.offset.end();
							break;
						// page up, page down
						case 33:
							disk.offset.move( 0, 0, -1 );
							break;
						case 34:
							disk.offset.move( 0, 0, 1 );
							break;
						// left, up, right, down
						case 37:
							disk.offset.move( -1, 0, 0 );
							break;
						case 38:
							disk.offset.move( 0, -1, 0 );
							break;
						case 39:
							disk.offset.move( 1, 0, 0 );
							break;
						case 40:
							disk.offset.move( 0, 1, 0 );
							break;
						// +, -
						case 107:
							disk.changeBlockStyle( 1, 2 );
							break;
						case 109:
							disk.changeBlockStyle( -1, -2 );
							break;
						// [, ] // Move to previous/next (bad) block
						case 219:
							disk.offset.blockPrev();
							break;
						case 221:
							disk.offset.blockNext();
							break;
						default:
							goodKey = false;
					}
					// If key is recognized redraw board
					if( goodKey )
						disk.visualize();
				}, false );
			} );

			// Start parser when input field changes
			var input = document.getElementById( "input" );
			input.addEventListener( "change", function() {
				parser.feed( input.value, false );
			}, false );


		}, false );

	</script>

</head>

<body>

	<div class="wrapper">

		<div class="cwrap">
			<canvas id="canvas">
				<p>Damn, download a better browser!</p>
			</canvas>
		</div>
		
		<div id="options">
			<p>
				Options there, welcome.
				What do you have problem with?
			</p>
			Keybindings:
			<table>
				<tr>
					<th>Keys</th>
					<th>Action</th>
				</tr>
				<tr>
					<td>Arrows, Page up/down, Home, End</td>
					<td>Navigate through blocs</td>
				</tr>
				<tr>
					<td>+, -</td>
					<td>Change resolution</td>
				</tr>
				<tr>
					<td>[, ]</td>
					<td>Move to previous/next (bad) block</td>
				</tr>
			</table>
			Put data here:
			<div class="twrap">
				<textarea id="input"></textarea>
			</div>
		</div>

		<div id="info">
			Hi there. Give me some data! Move cursor to the bottom left corner for help.
		</div>

	</div>

</body>

</html>
